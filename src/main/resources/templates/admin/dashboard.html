<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Администрирование</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<header class="topbar">
    <h1>Object Manager</h1>
    <nav>
        <a href="/objects">Объекты</a>
        <a href="/customers">Заказчики</a>
        <a href="/admin" class="active" sec:authorize="hasRole('ADMIN')">Администрирование</a>
        <form method="post" action="/logout">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="link-button">Выход</button>
        </form>
    </nav>
</header>
<main class="content admin-grid">
    <section class="card">
        <h2>PostgreSQL подключение</h2>
        <p>Укажите параметры подключения. При сохранении мы проверим сокет-соединение и создадим необходимые таблицы.</p>
        <form method="post" action="/admin/database" class="grid-form" th:object="${dbForm}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div>
                <label for="db-name">Название подключения</label>
                <input type="text" id="db-name" th:field="*{name}" required>
            </div>
            <div>
                <label for="host">Хост</label>
                <input type="text" id="host" th:field="*{host}" required>
            </div>
            <div>
                <label for="port">Порт</label>
                <input type="number" id="port" th:field="*{port}" min="1" max="65535" required>
            </div>
            <div>
                <label for="databaseName">База данных</label>
                <input type="text" id="databaseName" th:field="*{databaseName}" required>
            </div>
            <div>
                <label for="username">Пользователь</label>
                <input type="text" id="username" th:field="*{username}" required>
            </div>
            <div>
                <label for="password">Пароль</label>
                <input type="password" id="password" th:field="*{password}">
            </div>
            <div class="form-row">
                <button type="submit">Проверить и сохранить</button>
            </div>
        </form>
        <h3>Сохранённые подключения</h3>
        <p th:if="${#lists.isEmpty(connections)}">Подключения ещё не добавлены.</p>
        <table class="data-table" th:if="${!#lists.isEmpty(connections)}">
            <thead>
            <tr>
                <th>Название</th>
                <th>Тип</th>
                <th>Хост/URL</th>
                <th>Пользователь</th>
                <th>Статус</th>
                <th>Обновлено</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="connection : ${connections}">
                <td th:text="${connection.name}"></td>
                <td th:text="${connection.databaseType}"></td>
                <td th:text="${connection.databaseType.name() == 'H2' ? connection.databaseName : connection.host + ':' + connection.port}"></td>
                <td th:text="${connection.username}"></td>
                <td>
                    <span th:class="${connection.initialized} ? 'badge success' : 'badge danger'"
                          th:text="${connection.statusMessage}"></span>
                </td>
                <td th:text="${connection.lastVerifiedAt}"></td>
            </tr>
            </tbody>
        </table>
    </section>

    <section class="card">
        <h2>Локальная база H2</h2>
        <p>Создайте файл-базу H2 для автономного хранения данных. Приложение по умолчанию использует встроенную H2 в памяти.</p>
        <form method="post" action="/admin/database/h2" class="inline-form" th:object="${h2Form}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="text" th:field="*{name}" placeholder="object-storage" required>
            <button type="submit">Создать</button>
        </form>
    </section>

    <section class="card">
        <h2>Объекты ожидающие решения</h2>
        <p class="muted">Пользователи не видят объекты из этого списка. Администратор может удалить или перенести их.</p>
        <p th:if="${#lists.isEmpty(pendingObjects)}">Запросов на удаление нет.</p>
        <div class="stack" th:if="${!#lists.isEmpty(pendingObjects)}">
            <article class="stack-item" th:each="object : ${pendingObjects}">
                <header>
                    <h3 th:text="${object.name}"></h3>
                    <span class="badge warning">Удаление запрошено <span th:text="${object.deletionRequestedAt}"></span></span>
                </header>
                <p>Заказчик: <strong th:text="${object.customer.name}"></strong></p>
                <p th:text="${object.description}"></p>
                <details>
                    <summary>Переместить к другому заказчику или переименовать</summary>
                    <form th:action="@{'/admin/objects/' + ${object.id} + '/transfer'}" method="post" class="grid-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <div>
                            <label>Название</label>
                            <input type="text" name="name" th:placeholder="${object.name}">
                        </div>
                        <div>
                            <label>Описание</label>
                            <textarea name="description" rows="2" th:placeholder="${object.description}"></textarea>
                        </div>
                        <div>
                            <label>Первичные данные</label>
                            <textarea name="primaryData" rows="3" th:placeholder="${object.primaryData}"></textarea>
                        </div>
                        <div>
                            <label>Новый заказчик</label>
                            <select name="customerId" required>
                                <option th:each="customer : ${customers}" th:value="${customer.id}" th:text="${customer.name}" th:selected="${customer.id == object.customer.id}"></option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit">Перенести</button>
                        </div>
                    </form>
                </details>
                <form th:action="@{'/admin/objects/' + ${object.id} + '/delete'}" method="post" class="inline-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="button danger">Удалить объект</button>
                </form>
            </article>
        </div>
    </section>

    <section class="card">
        <h2>Управление пользователями</h2>
        <form method="post" action="/admin/users" class="inline-form" th:object="${userForm}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="text" th:field="*{username}" placeholder="логин" required>
            <input type="password" th:field="*{password}" placeholder="пароль" required>
            <label class="checkbox">
                <input type="checkbox" th:field="*{admin}"> Администратор
            </label>
            <button type="submit">Добавить</button>
        </form>
        <table class="data-table">
            <thead>
            <tr>
                <th>Имя пользователя</th>
                <th>Роли</th>
                <th>Активен</th>
                <th>Создан</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}">
                <td th:text="${user.username}"></td>
                <td th:text="${#strings.listJoin(user.roles, ', ')}"></td>
                <td th:text="${user.enabled ? 'Да' : 'Нет'}"></td>
                <td th:text="${user.createdAt}"></td>
            </tr>
            </tbody>
        </table>
    </section>
</main>
<footer class="footer">
    <p>Object Manager &copy; 2025</p>
</footer>
</body>
</html>
