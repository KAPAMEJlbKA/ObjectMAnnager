<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Администрирование</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<header class="topbar">
    <h1>Object Manager</h1>
    <nav>
        <a href="/objects">Объекты</a>
        <a href="/customers">Заказчики</a>
        <a href="/admin" class="active" sec:authorize="hasRole('ADMIN')">Администрирование</a>
        <form method="post" action="/logout">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="link-button">Выход</button>
        </form>
    </nav>
</header>
<main class="content">
    <div class="admin-layout">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <button type="button" class="section-link active" data-section="connections">Подключения</button>
                <button type="button" class="section-link" data-section="settings">Настройки</button>
                <button type="button" class="section-link" data-section="objects">Объекты</button>
                <button type="button" class="section-link" data-section="users">Пользователи</button>
                <button type="button" class="section-link" data-section="references">Справочники</button>
                <button type="button" class="section-link" data-section="equipment">Оборудование</button>
            </nav>
        </aside>
        <div class="section-content">
            <section class="section-panel active" data-section="connections">
                <section class="card">
                    <h2>PostgreSQL подключение</h2>
                    <p>Укажите параметры подключения. При сохранении мы проверим сокет-соединение и создадим необходимые таблицы.</p>
                    <form method="post" action="/admin/database" class="grid-form" th:object="${dbForm}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <div>
                            <label for="db-name">Название подключения</label>
                            <input type="text" id="db-name" th:field="*{name}" required>
                        </div>
                        <div>
                            <label for="host">Хост</label>
                            <input type="text" id="host" th:field="*{host}" required>
                        </div>
                        <div>
                            <label for="port">Порт</label>
                            <input type="number" id="port" th:field="*{port}" min="1" max="65535" required>
                        </div>
                        <div>
                            <label for="databaseName">База данных</label>
                            <input type="text" id="databaseName" th:field="*{databaseName}" required>
                        </div>
                        <div>
                            <label for="username">Пользователь</label>
                            <input type="text" id="username" th:field="*{username}" required>
                        </div>
                        <div>
                            <label for="password">Пароль</label>
                            <input type="password" id="password" th:field="*{password}">
                        </div>
                        <div class="form-row">
                            <button type="submit">Проверить и сохранить</button>
                        </div>
                    </form>
                    <h3>Сохранённые подключения</h3>
                    <p th:if="${#lists.isEmpty(connections)}">Подключения ещё не добавлены.</p>
                    <table class="data-table" th:if="${!#lists.isEmpty(connections)}">
                        <thead>
                        <tr>
                            <th>Название</th>
                            <th>Тип</th>
                            <th>Хост/URL</th>
                            <th>Пользователь</th>
                            <th>Статус</th>
                            <th>Обновлено</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="connection : ${connections}">
                            <td th:text="${connection.name}"></td>
                            <td th:text="${connection.databaseType}"></td>
                            <td th:text="${connection.databaseType.name() == 'H2' ? connection.databaseName : connection.host + ':' + connection.port}"></td>
                            <td th:text="${connection.username}"></td>
                            <td>
                                <span th:class="${connection.initialized} ? 'badge success' : 'badge danger'"
                                      th:text="${connection.statusMessage}"></span>
                            </td>
                            <td th:text="${connection.lastVerifiedAt != null ? #temporals.format(connection.lastVerifiedAt, 'HH:mm dd:MM:yyyy') : '—'}"></td>
                        </tr>
                        </tbody>
                    </table>
                </section>
                <section class="card">
                    <h2>Локальная база H2</h2>
                    <p>Создайте файл-базу H2 для автономного хранения данных. Приложение по умолчанию использует файловую базу H2 в каталоге <code>data</code>.</p>
                    <form method="post" action="/admin/database/h2" class="inline-form" th:object="${h2Form}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="text" th:field="*{name}" placeholder="object-storage" required>
                        <button type="submit">Создать</button>
                    </form>
                </section>
            </section>
            <section class="section-panel" data-section="settings">
                <section class="card">
                    <h2>Настройки карт</h2>
                    <p class="muted">Выберите сервис карт, который будет использоваться для ссылок на координаты объектов.</p>
                    <form method="post" action="/admin/settings/map-provider" class="inline-form" th:object="${mapSettingsForm}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <select th:field="*{mapProvider}">
                            <option th:value="${T(com.kapamejlbka.objectmannage.model.MapProvider).YANDEX}">Яндекс.Карты</option>
                            <option th:value="${T(com.kapamejlbka.objectmannage.model.MapProvider).GOOGLE}">Google Maps</option>
                        </select>
                        <button type="submit">Сохранить</button>
                    </form>
                </section>
                <section class="card">
                    <h2>Коэффициенты монтажных материалов</h2>
                    <p class="muted">Используются для расчёта вспомогательных материалов по длине кабельных линий и гофрированной трубы.</p>
                    <form method="post" action="/admin/settings/material-coefficients" class="grid-form" th:object="${materialCoefficientsForm}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <div>
                            <label for="clips-per-meter">Клипсы на 1 метр гофры</label>
                            <input type="number" id="clips-per-meter" th:field="*{clipsPerMeter}" min="0" step="0.1">
                        </div>
                        <div>
                            <label for="ties-per-meter">Стяжки на 1 метр кабеля</label>
                            <input type="number" id="ties-per-meter" th:field="*{tiesPerMeter}" min="0" step="0.1">
                        </div>
                        <div class="form-row">
                            <button type="submit">Сохранить</button>
                        </div>
                    </form>
                </section>
                <section class="card">
                    <h2>Логотип компании</h2>
                    <p class="muted">Загруженный логотип будет отображаться на титульной странице отчёта.</p>
                    <div class="logo-preview" th:if="${currentLogo != null}">
                        <img th:src="${currentLogo}" alt="Логотип компании">
                        <form method="post" action="/admin/settings/company-logo/remove" class="inline-form">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="button danger">Удалить логотип</button>
                        </form>
                    </div>
                    <form method="post" action="/admin/settings/company-logo" enctype="multipart/form-data" class="grid-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <div>
                            <label for="logo">Загрузить логотип</label>
                            <input type="file" id="logo" name="logo" accept="image/*" required>
                        </div>
                        <div class="form-row">
                            <button type="submit">Обновить логотип</button>
                        </div>
                    </form>
                </section>
            </section>
            <section class="section-panel" data-section="objects">
                <section class="card">
                    <h2>Объекты ожидающие решения</h2>
                    <p class="muted">Пользователи не видят объекты из этого списка. Администратор может удалить или перенести их.</p>
                    <p th:if="${#lists.isEmpty(pendingObjects)}">Запросов на удаление нет.</p>
                    <div class="stack" th:if="${!#lists.isEmpty(pendingObjects)}">
                        <article class="stack-item" th:each="object : ${pendingObjects}">
                            <header>
                                <h3 th:text="${object.name}"></h3>
                            <span class="badge warning">Удаление запрошено <span th:text="${object.deletionRequestedAt != null ? #temporals.format(object.deletionRequestedAt, 'HH:mm dd:MM:yyyy') : '—'}"></span></span>
                            </header>
                            <p>Заказчик: <strong th:text="${object.customer.name}"></strong></p>
                            <p th:text="${object.description}"></p>
                            <details>
                                <summary>Переместить к другому заказчику или переименовать</summary>
                                <form th:action="@{'/admin/objects/' + ${object.id} + '/transfer'}" method="post" class="grid-form">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <div>
                                        <label>Название</label>
                                        <input type="text" name="name" th:placeholder="${object.name}">
                                    </div>
                                    <div>
                                        <label>Описание</label>
                                        <textarea name="description" rows="2" th:placeholder="${object.description}"></textarea>
                                    </div>
                                    <div>
                                        <label>Первичные данные</label>
                                        <textarea name="primaryData" rows="3" th:placeholder="${object.primaryData}"></textarea>
                                    </div>
                                    <div class="grid">
                                        <div>
                                            <label>Широта</label>
                                            <input type="number" name="latitude" step="0.000001" th:placeholder="${object.latitude}">
                                        </div>
                                        <div>
                                            <label>Долгота</label>
                                            <input type="number" name="longitude" step="0.000001" th:placeholder="${object.longitude}">
                                        </div>
                                    </div>
                                    <div>
                                        <label>Новый заказчик</label>
                                        <select name="customerId" required>
                                            <option th:each="customer : ${customers}" th:value="${customer.id}" th:text="${customer.name}" th:selected="${customer.id == object.customer.id}"></option>
                                        </select>
                                    </div>
                                    <div class="form-row">
                                        <button type="submit">Перенести</button>
                                    </div>
                                </form>
                            </details>
                            <form th:action="@{'/admin/objects/' + ${object.id} + '/delete'}" method="post" class="inline-form">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button type="submit" class="button danger">Удалить объект</button>
                            </form>
                        </article>
                    </div>
                </section>
            </section>
            <section class="section-panel" data-section="users">
                <section class="card">
                    <h2>Управление пользователями</h2>
                    <form method="post" action="/admin/users" class="inline-form" th:object="${userForm}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="text" th:field="*{username}" placeholder="логин" required>
                        <input type="password" th:field="*{password}" placeholder="пароль" required>
                        <label class="checkbox">
                            <input type="checkbox" th:field="*{admin}"> Администратор
                        </label>
                        <button type="submit">Добавить</button>
                    </form>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Имя пользователя</th>
                            <th>Роли</th>
                            <th>Активен</th>
                            <th>Создан</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.username}"></td>
                            <td th:text="${#strings.listJoin(user.roles, ', ')}"></td>
                            <td th:text="${user.enabled ? 'Да' : 'Нет'}"></td>
                            <td th:text="${user.createdAt != null ? #temporals.format(user.createdAt, 'HH:mm dd:MM:yyyy') : '—'}"></td>
                        </tr>
                        </tbody>
                    </table>
                </section>
            </section>
            <section class="section-panel" data-section="references">
                <section class="card">
                    <h2>Справочники для первичных данных</h2>
                    <div class="reference-tabs" data-storage-key="admin-reference-tab">
                        <div class="reference-tab-nav">
                            <button type="button" class="reference-tab-link active" data-ref-tab="device-types">Типы конечных устройств</button>
                            <button type="button" class="reference-tab-link" data-ref-tab="mounting-elements">Монтажные элементы</button>
                            <button type="button" class="reference-tab-link" data-ref-tab="installation-materials">Монтажные материалы</button>
                            <button type="button" class="reference-tab-link" data-ref-tab="cable-types">Типы кабелей</button>
                        </div>
                        <div class="reference-tab-panels">
                            <div class="reference-tab-panel active" data-ref-tab="device-types">
                                <h3>Типы конечных устройств</h3>
                                <form method="post" action="/admin/device-types" class="inline-form" th:object="${deviceTypeForm}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <input type="text" th:field="*{name}" placeholder="Видеокамера" required>
                                    <button type="submit">Добавить</button>
                                </form>
                                <p th:if="${#lists.isEmpty(deviceTypes)}" class="muted">Список пуст.</p>
                                <div th:if="${!#lists.isEmpty(deviceTypes)}" class="table-container">
                                    <table class="data-table">
                                        <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th class="actions">Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="type : ${deviceTypes}">
                                            <td th:text="${type.name}"></td>
                                            <td class="actions">
                                                <form method="post" th:action="@{'/admin/device-types/' + ${type.id} + '/delete'}">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                                    <button type="submit" class="link-button danger">Удалить</button>
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="reference-tab-panel" data-ref-tab="mounting-elements">
                                <h3>Монтажные элементы</h3>
                                <form method="post" action="/admin/mounting-elements" class="inline-form" th:object="${mountingElementForm}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <input type="text" th:field="*{name}" placeholder="Монтажный шкаф" required>
                                    <button type="submit">Добавить</button>
                                </form>
                                <p th:if="${#lists.isEmpty(mountingElements)}" class="muted">Список пуст.</p>
                                <div th:if="${!#lists.isEmpty(mountingElements)}" class="table-container">
                                    <table class="data-table">
                                        <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th class="actions">Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="element : ${mountingElements}">
                                            <td th:text="${element.name}"></td>
                                            <td class="actions">
                                                <form method="post" th:action="@{'/admin/mounting-elements/' + ${element.id} + '/delete'}">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                                    <button type="submit" class="link-button danger">Удалить</button>
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="reference-tab-panel" data-ref-tab="installation-materials">
                                <h3>Монтажные материалы</h3>
                                <form method="post" action="/admin/installation-materials" class="grid-form" th:object="${installationMaterialForm}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <input type="text" th:field="*{name}" placeholder="Гофротруба" required>
                                    <input type="text" th:field="*{unit}" placeholder="м, шт, коробка">
                                    <div class="form-row">
                                        <button type="submit">Добавить</button>
                                    </div>
                                </form>
                                <p th:if="${#lists.isEmpty(installationMaterials)}" class="muted">Список пуст.</p>
                                <div th:if="${!#lists.isEmpty(installationMaterials)}" class="table-container">
                                    <table class="data-table">
                                        <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th>Единица</th>
                                            <th class="actions">Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="material : ${installationMaterials}">
                                            <td th:text="${material.name}"></td>
                                            <td th:text="${material.unit != null ? material.unit : '—'}"></td>
                                            <td class="actions">
                                                <form method="post" th:action="@{'/admin/installation-materials/' + ${material.id} + '/delete'}">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                                    <button type="submit" class="link-button danger">Удалить</button>
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="reference-tab-panel" data-ref-tab="cable-types">
                                <h3>Типы кабелей</h3>
                                <p class="muted">Категории: сигнальный, кабель для слаботочного питания, силовой.</p>
                                <form method="post" action="/admin/cable-types" class="inline-form" th:object="${cableTypeForm}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <input type="text" th:field="*{name}" placeholder="UTP 5e" required>
                                    <select th:field="*{function}">
                                        <option th:each="function : ${T(com.kapamejlbka.objectmannage.model.CableFunction).values()}"
                                                th:value="${function}"
                                                th:text="${function.displayName}"></option>
                                    </select>
                                    <button type="submit">Добавить</button>
                                </form>
                                <p th:if="${#lists.isEmpty(cableTypes)}" class="muted">Список пуст.</p>
                                <div th:if="${!#lists.isEmpty(cableTypes)}" class="table-container">
                                    <table class="data-table">
                                        <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th>Категория</th>
                                            <th class="actions">Действия</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="cable : ${cableTypes}">
                                            <td>
                                                <strong th:text="${cable.name}"></strong>
                                            </td>
                                            <td>
                                                <span class="badge secondary" th:text="${cable.function.displayName}"></span>
                                            </td>
                                            <td class="actions">
                                                <form method="post" th:action="@{'/admin/cable-types/' + ${cable.id} + '/delete'}">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                                    <button type="submit" class="link-button danger">Удалить</button>
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </section>
            <section class="section-panel" data-section="equipment">
                <section class="card">
                    <h2>Оборудование</h2>
                    <p class="muted">Раздел в разработке. Мы вернёмся к нему позже.</p>
                </section>
            </section>
        </div>
    </div>
</main>
<footer class="footer">
    <p>Object Manager &copy; 2025</p>
</footer>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sectionLinks = Array.from(document.querySelectorAll('.section-link'));
        const sectionPanels = Array.from(document.querySelectorAll('.section-panel'));
        const STORAGE_SECTION_KEY = 'admin-active-section';
        const STORAGE_SCROLL_KEY = 'admin-scroll-position';
        let currentSection = localStorage.getItem(STORAGE_SECTION_KEY) || '';

        function activateSection(section) {
            if (!sectionLinks.length) {
                return;
            }
            let targetSection = section;
            let targetLink = sectionLinks.find(link => link.dataset.section === targetSection);
            if (!targetLink) {
                targetLink = sectionLinks[0];
                targetSection = targetLink?.dataset.section || '';
            }
            if (!targetLink) {
                return;
            }
            sectionLinks.forEach(link => link.classList.toggle('active', link === targetLink));
            sectionPanels.forEach(panel => panel.classList.toggle('active', panel.dataset.section === targetSection));
            currentSection = targetSection;
            if (currentSection) {
                localStorage.setItem(STORAGE_SECTION_KEY, currentSection);
            }
        }

        activateSection(currentSection);

        sectionLinks.forEach(link => {
            link.addEventListener('click', () => {
                activateSection(link.dataset.section || '');
            });
        });

        document.querySelectorAll('.reference-tabs').forEach(container => {
            const storageKey = container.dataset.storageKey || 'admin-reference-tab';
            const tabLinks = Array.from(container.querySelectorAll('.reference-tab-link'));
            const tabPanels = Array.from(container.querySelectorAll('.reference-tab-panel'));
            let currentTab = localStorage.getItem(storageKey) || '';

            function activateTab(tab) {
                if (!tabLinks.length) {
                    return;
                }
                let targetTab = tab;
                let targetLink = tabLinks.find(link => link.dataset.refTab === targetTab);
                if (!targetLink) {
                    targetLink = tabLinks[0];
                    targetTab = targetLink?.dataset.refTab || '';
                }
                if (!targetLink) {
                    return;
                }
                tabLinks.forEach(link => link.classList.toggle('active', link === targetLink));
                tabPanels.forEach(panel => panel.classList.toggle('active', panel.dataset.refTab === targetTab));
                currentTab = targetTab;
                if (currentTab) {
                    localStorage.setItem(storageKey, currentTab);
                }
            }

            activateTab(currentTab);

            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    activateTab(link.dataset.refTab || '');
                });
            });
        });

        const savedScroll = Number.parseInt(localStorage.getItem(STORAGE_SCROLL_KEY) || '', 10);
        if (!Number.isNaN(savedScroll)) {
            window.scrollTo({ top: savedScroll });
        }

        window.addEventListener('beforeunload', () => {
            localStorage.setItem(STORAGE_SCROLL_KEY, String(window.scrollY));
            if (currentSection) {
                localStorage.setItem(STORAGE_SECTION_KEY, currentSection);
            }
        });
    });
</script>
</body>
</html>
