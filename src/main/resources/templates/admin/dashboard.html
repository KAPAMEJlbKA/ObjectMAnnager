<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, 'admin', ~{::content}, ~{::extraHead}, ~{::extraScripts})}">
<head>
    <title>Администрирование</title>
    <th:block th:fragment="extraHead">
        <style>
            .om-page-card {
                background: #fff;
                border: 1px solid #e6e6e6;
                border-radius: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
                padding: 1.5rem;
            }

            .form-two-col .col-form-label {
                font-weight: 600;
            }
        </style>
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-0">Администрирование</h1>
            <p class="text-muted mb-0">Управление пользователями, настройками и справочниками</p>
        </div>
    </div>

    <div th:if="${flashSuccess}" class="alert alert-success" role="alert" th:text="${flashSuccess}"></div>
    <div th:if="${flashError}" class="alert alert-danger" role="alert" th:text="${flashError}"></div>

    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link" th:classappend="${activeTab} == 'users' ? ' active' : ''" th:href="@{/admin(tab='users')}">Пользователи</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" th:classappend="${activeTab} == 'settings' ? ' active' : ''" th:href="@{/admin(tab='settings')}">Настройки</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" th:classappend="${activeTab} == 'materials' ? ' active' : ''" th:href="@{/admin(tab='materials')}">Материалы</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" th:classappend="${activeTab} == 'norms' ? ' active' : ''" th:href="@{/admin(tab='norms')}">Нормы расчёта</a>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane" th:classappend="${activeTab} == 'users' ? ' show active' : ''" id="tab-users" role="tabpanel">
            <div class="om-page-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 mb-0">Пользователи</h2>
                    <a class="btn btn-primary btn-sm" th:href="@{/admin(tab='users')}">Создать пользователя</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-3">
                        <thead>
                        <tr>
                            <th>Логин</th>
                            <th>ФИО</th>
                            <th>Email</th>
                            <th>Роли</th>
                            <th>Статус</th>
                            <th class="text-end">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.username}"></td>
                            <td th:text="${user.fullName}"></td>
                            <td th:text="${user.email}"></td>
                            <td>
                                <span class="badge text-bg-secondary me-1" th:each="role : ${user.roles}" th:text="${role.name}"></span>
                            </td>
                            <td>
                                <span th:class="${user.enabled} ? 'badge text-bg-success' : 'badge text-bg-danger'"
                                      th:text="${user.enabled} ? 'Включён' : 'Отключён'"></span>
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-primary" th:href="@{/admin(tab='users', editUserId=${user.id})}">Редактировать</a>
                                    <form th:action="@{'/admin/users/' + ${user.id} + '/status'}" method="post" class="d-inline">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        <input type="hidden" name="enabled" th:value="${!user.enabled}">
                                        <button type="submit" class="btn" th:classappend="${user.enabled} ? 'btn-outline-warning' : 'btn-outline-success'"
                                                th:text="${user.enabled} ? 'Заблокировать' : 'Разблокировать'"></button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="border rounded p-3 h-100">
                            <h3 class="h6">Создать пользователя</h3>
                            <form th:action="@{/admin/users}" th:object="${userForm}" method="post" class="row g-3 form-two-col">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <div class="col-sm-4 col-form-label">Логин</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{username}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Временный пароль</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{password}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">ФИО</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{fullName}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Email</div>
                                <div class="col-sm-8">
                                    <input type="email" th:field="*{email}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Роли</div>
                                <div class="col-sm-8">
                                    <div class="form-check" th:each="role : ${roles}">
                                        <input class="form-check-input" type="checkbox" th:field="*{roles}" th:value="${role.name}" th:id="${'role_' + role.id}">
                                        <label class="form-check-label" th:for="${'role_' + role.id}" th:text="${role.name}"></label>
                                    </div>
                                </div>
                                <div class="col-sm-4 col-form-label">Включён</div>
                                <div class="col-sm-8 d-flex align-items-center gap-2">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" th:field="*{enabled}" checked>
                                    </div>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary">Создать</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-lg-6" th:if="${editUserForm != null}">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="h6 mb-0">Редактирование пользователя</h3>
                                <a class="btn btn-sm btn-outline-secondary" th:href="@{/admin(tab='users')}">Отменить</a>
                            </div>
                            <form th:action="@{'/admin/users/' + ${editUserForm.id}}" th:object="${editUserForm}" method="post" class="row g-3 form-two-col mt-3">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <div class="col-sm-4 col-form-label">Логин</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{username}" class="form-control" readonly>
                                </div>
                                <div class="col-sm-4 col-form-label">ФИО</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{fullName}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Email</div>
                                <div class="col-sm-8">
                                    <input type="email" th:field="*{email}" class="form-control">
                                </div>
                                <div class="col-sm-4 col-form-label">Роли</div>
                                <div class="col-sm-8">
                                    <div class="form-check" th:each="role : ${roles}">
                                        <input class="form-check-input" type="checkbox" th:field="*{roles}" th:value="${role.name}" th:id="${'edit_role_' + role.id}">
                                        <label class="form-check-label" th:for="${'edit_role_' + role.id}" th:text="${role.name}"></label>
                                    </div>
                                </div>
                                <div class="col-sm-4 col-form-label">Статус</div>
                                <div class="col-sm-8">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" th:field="*{enabled}">
                                        <label class="form-check-label" for="enabled">Включён</label>
                                    </div>
                                </div>
                                <div class="col-sm-4 col-form-label">Новый пароль</div>
                                <div class="col-sm-8">
                                    <input type="password" th:field="*{newPassword}" class="form-control" placeholder="Оставьте пустым, чтобы не менять">
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane" th:classappend="${activeTab} == 'settings' ? ' show active' : ''" id="tab-settings" role="tabpanel">
            <div class="om-page-card">
                <h2 class="h5 mb-3">Настройки расчёта</h2>
                <form th:action="@{/admin/settings}" th:object="${settings}" method="post" class="row g-3 align-items-center">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="col-md-6">
                        <label for="standardCabinetDropLengthMeters" class="form-label">Стандартный опуск кабеля к шкафу, м</label>
                        <input type="number" step="0.1" min="0" class="form-control" id="standardCabinetDropLengthMeters" th:field="*{standardCabinetDropLengthMeters}" placeholder="2.0">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="tab-pane" th:classappend="${activeTab} == 'materials' ? ' show active' : ''" id="tab-materials" role="tabpanel">
            <div class="om-page-card">
                <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center mb-3">
                    <h2 class="h5 mb-0">Материалы</h2>
                    <form class="d-flex flex-wrap gap-2" method="get" action="/admin">
                        <input type="hidden" name="tab" value="materials">
                        <input type="search" name="search" class="form-control" placeholder="Поиск" th:value="${materialQuery}" style="min-width: 200px;">
                        <select name="category" class="form-select">
                            <option value="" th:selected="${materialCategory == ''}">Все категории</option>
                            <option th:each="cat : ${materialCategories}" th:value="${cat}" th:text="${cat}" th:selected="${cat == materialCategory}"></option>
                        </select>
                        <button type="submit" class="btn btn-outline-secondary">Фильтр</button>
                    </form>
                </div>

                <div class="table-responsive mb-4">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Код</th>
                            <th>Название</th>
                            <th>Категория</th>
                            <th>Ед. изм.</th>
                            <th>Примечание</th>
                            <th class="text-end">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="material : ${materials}">
                            <td th:text="${material.code}"></td>
                            <td th:text="${material.name}"></td>
                            <td th:text="${material.category}"></td>
                            <td th:text="${material.unit}"></td>
                            <td th:text="${material.notes}"></td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-primary" th:href="@{/admin(tab='materials', editMaterialId=${material.id}, search=${materialQuery}, category=${materialCategory})}">Редактировать</a>
                                    <form th:action="@{'/admin/materials/' + ${material.id} + '/delete'}" method="post" class="d-inline" onsubmit="return confirm('Удалить материал?');">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        <button type="submit" class="btn btn-outline-danger">Удалить</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="border rounded p-3 h-100">
                            <h3 class="h6">Добавить материал</h3>
                            <form th:action="@{/admin/materials}" th:object="${materialForm}" method="post" class="row g-3 form-two-col">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <div class="col-sm-4 col-form-label">Код</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{code}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Название</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{name}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Категория</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{category}" class="form-control" placeholder="PIPE, CLIP...">
                                </div>
                                <div class="col-sm-4 col-form-label">Ед. изм.</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{unit}" class="form-control" placeholder="шт, м" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Примечание</div>
                                <div class="col-sm-8">
                                    <textarea th:field="*{notes}" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary">Добавить</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-6" th:if="${editMaterialForm != null}">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="h6 mb-0">Редактирование материала</h3>
                                <a class="btn btn-sm btn-outline-secondary" th:href="@{/admin(tab='materials', search=${materialQuery}, category=${materialCategory})}">Отменить</a>
                            </div>
                            <form th:action="@{'/admin/materials/' + ${editMaterialForm.id}}" th:object="${editMaterialForm}" method="post" class="row g-3 form-two-col mt-3">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <div class="col-sm-4 col-form-label">Код</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{code}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Название</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{name}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Категория</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{category}" class="form-control">
                                </div>
                                <div class="col-sm-4 col-form-label">Ед. изм.</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{unit}" class="form-control" required>
                                </div>
                                <div class="col-sm-4 col-form-label">Примечание</div>
                                <div class="col-sm-8">
                                    <textarea th:field="*{notes}" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary">Сохранить</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane" th:classappend="${activeTab} == 'norms' ? ' show active' : ''" id="tab-norms" role="tabpanel">
            <div class="om-page-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 mb-0">Нормы расчёта</h2>
                    <a class="btn btn-sm btn-outline-secondary" th:href="@{/admin(tab='norms')}">Добавить норму</a>
                </div>
                <div class="table-responsive mb-4">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Контекст</th>
                            <th>Материал</th>
                            <th>Формула</th>
                            <th>Описание</th>
                            <th class="text-end">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="norm : ${norms}">
                            <td th:text="${normContextNames.get(norm.contextType)}"></td>
                            <td th:text="${norm.material != null ? norm.material.name : '—'}"></td>
                            <td><code th:text="${norm.formula}"></code></td>
                            <td th:text="${norm.description}"></td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-primary" th:href="@{/admin(tab='norms', editNormId=${norm.id})}">Редактировать</a>
                                    <form th:action="@{'/admin/norms/' + ${norm.id} + '/delete'}" method="post" class="d-inline" onsubmit="return confirm('Удалить норму?');">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                        <button type="submit" class="btn btn-outline-danger">Удалить</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="border rounded p-3 h-100">
                            <h3 class="h6">Добавить норму</h3>
                            <form th:action="@{/admin/norms}" th:object="${normForm}" method="post" class="row g-3 form-two-col">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <div class="col-sm-4 col-form-label">Контекст</div>
                                <div class="col-sm-8">
                                    <select th:field="*{contextType}" class="form-select" required>
                                        <option value="">Выберите контекст</option>
                                        <option th:each="entry : ${normContextNames.entrySet()}" th:value="${entry.key}" th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                <div class="col-sm-4 col-form-label">Материал</div>
                                <div class="col-sm-8">
                                    <select th:field="*{materialId}" class="form-select" required>
                                        <option value="">Выберите материал</option>
                                        <option th:each="material : ${normMaterials}" th:value="${material.id}" th:text="${material.name + ' (' + material.code + ')'}"></option>
                                    </select>
                                </div>
                                <div class="col-sm-4 col-form-label">Формула</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{formula}" class="form-control" placeholder="ceil(length / 0.4)" required>
                                    <small class="text-muted">Доступные переменные: length, deviceCount, extraSockets, fiberCores. Функции: ceil, floor, max, min.</small>
                                </div>
                                <div class="col-sm-4 col-form-label">Описание</div>
                                <div class="col-sm-8">
                                    <textarea th:field="*{description}" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary">Добавить</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-6" th:if="${editNormForm != null}">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="h6 mb-0">Редактирование нормы</h3>
                                <a class="btn btn-sm btn-outline-secondary" th:href="@{/admin(tab='norms')}">Отменить</a>
                            </div>
                            <form th:action="@{'/admin/norms/' + ${editNormForm.id}}" th:object="${editNormForm}" method="post" class="row g-3 form-two-col mt-3">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <div class="col-sm-4 col-form-label">Контекст</div>
                                <div class="col-sm-8">
                                    <select th:field="*{contextType}" class="form-select" required>
                                        <option th:each="entry : ${normContextNames.entrySet()}" th:value="${entry.key}" th:text="${entry.value}"></option>
                                    </select>
                                </div>
                                <div class="col-sm-4 col-form-label">Материал</div>
                                <div class="col-sm-8">
                                    <select th:field="*{materialId}" class="form-select" required>
                                        <option th:each="material : ${normMaterials}" th:value="${material.id}" th:text="${material.name + ' (' + material.code + ')'}"></option>
                                    </select>
                                </div>
                                <div class="col-sm-4 col-form-label">Формула</div>
                                <div class="col-sm-8">
                                    <input type="text" th:field="*{formula}" class="form-control" required>
                                    <small class="text-muted">Доступные переменные: length, deviceCount, extraSockets, fiberCores. Функции: ceil, floor, max, min.</small>
                                </div>
                                <div class="col-sm-4 col-form-label">Описание</div>
                                <div class="col-sm-8">
                                    <textarea th:field="*{description}" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>
<th:block th:fragment="extraScripts"></th:block>
</body>
</html>
