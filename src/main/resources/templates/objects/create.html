<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::title}, 'objects', ~{::content}, ~{::extraHead}, ~{::extraScripts})}">
<head>
    <title>Создание объекта</title>
    <th:block th:fragment="extraHead"></th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="om-page-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4 mb-0">Создать новый объект</h2>
            <a class="btn btn-outline-secondary" href="/objects">Назад</a>
        </div>
        <form method="post" action="/objects" th:object="${form}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="alert alert-danger" th:if="${#fields.hasErrors('*')}">
                <p class="mb-0" th:each="err : ${#fields.errors('*')}" th:text="${err}"></p>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Название</label>
                    <input type="text" id="name" th:field="*{name}" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="description" class="form-label">Описание</label>
                    <textarea id="description" th:field="*{description}" class="form-control" rows="3"></textarea>
                </div>
                <div class="col-md-6">
                    <label for="latitude" class="form-label">Широта</label>
                    <input type="number" id="latitude" th:field="*{latitude}" class="form-control" step="0.000001" placeholder="53.902496">
                </div>
                <div class="col-md-6">
                    <label for="longitude" class="form-label">Долгота</label>
                    <input type="number" id="longitude" th:field="*{longitude}" class="form-control" step="0.000001" placeholder="27.561481">
                </div>
                <div class="col-md-6">
                    <label for="customer" class="form-label">Заказчик</label>
                    <select id="customer" th:field="*{customerId}" class="form-select" th:disabled="${form.createNewCustomer}">
                        <option value="" disabled th:selected="${form.customerId} == null">Выберите заказчика</option>
                        <option th:each="customer : ${customers}" th:value="${customer.id}" th:text="${customer.name}" th:selected="${customer.id == form.customerId}"></option>
                    </select>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="createNewCustomer" th:field="*{createNewCustomer}">
                        <label class="form-check-label" for="createNewCustomer">Создать нового заказчика</label>
                    </div>
                </div>
            </div>
            <div id="newCustomerSection" th:classappend="${form.createNewCustomer} ? '' : ' is-hidden'" class="mt-3">
                <div class="om-page-card mb-0">
                    <h3 class="h6 mb-3">Новый заказчик</h3>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="newCustomerName" class="form-label">Название</label>
                            <input type="text" id="newCustomerName" th:field="*{newCustomer.name}" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="newCustomerEnterprise" class="form-label">Наименование предприятия</label>
                            <input type="text" id="newCustomerEnterprise" th:field="*{newCustomer.enterpriseName}" class="form-control" placeholder="ООО &quot;Ромашка&quot;">
                        </div>
                        <div class="col-md-6">
                            <label for="newCustomerTax" class="form-label">УНП</label>
                            <input type="text" id="newCustomerTax" th:field="*{newCustomer.taxNumber}" class="form-control" placeholder="123456789">
                        </div>
                        <div class="col-md-6">
                            <label for="newCustomerEmail" class="form-label">Email</label>
                            <input type="email" id="newCustomerEmail" th:field="*{newCustomer.contactEmail}" class="form-control" placeholder="client@example.com">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Контактные телефоны</label>
                            <div id="object-customer-phones" class="d-flex flex-column gap-2">
                                <div class="d-flex align-items-center gap-2 phone-row" th:each="phone, iter : *{newCustomer.contactPhones}" th:data-index="${iter.index}">
                                    <input type="text" th:field="*{newCustomer.contactPhones[__${iter.index}__]}" class="form-control" placeholder="+375(29) 000-00-00">
                                    <button type="button" class="btn btn-outline-secondary btn-sm remove-object-phone" th:if="${iter.index > 0}">Удалить</button>
                                </div>
                            </div>
                            <template id="object-phone-template">
                                <div class="d-flex align-items-center gap-2 phone-row">
                                    <input type="text" name="newCustomer.contactPhones[__index__]" class="form-control" placeholder="+375 (29) 000-00-00">
                                    <button type="button" class="btn btn-outline-secondary btn-sm remove-object-phone">Удалить</button>
                                </div>
                            </template>
                            <button type="button" id="addObjectPhone" class="btn btn-outline-secondary btn-sm mt-2">Добавить телефон</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <a class="btn btn-outline-secondary" href="/objects">Отмена</a>
                <button type="submit" class="btn btn-primary">Создать</button>
            </div>
        </form>
    </div>
</th:block>
<th:block th:fragment="extraScripts">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('createNewCustomer');
            const section = document.getElementById('newCustomerSection');
            const customerSelect = document.getElementById('customer');
            const phoneContainer = document.getElementById('object-customer-phones');
            const phoneTemplate = document.getElementById('object-phone-template');
            const addPhoneButton = document.getElementById('addObjectPhone');

            function updateVisibility() {
                const creating = toggle?.checked;
                if (section) {
                    section.classList.toggle('is-hidden', !creating);
                }
                if (customerSelect) {
                    customerSelect.disabled = Boolean(creating);
                    if (creating) {
                        customerSelect.value = '';
                    }
                }
            }

            function reindexPhones() {
                if (!phoneContainer) {
                    return;
                }
                const rows = phoneContainer.querySelectorAll('.phone-row');
                rows.forEach((row, index) => {
                    const input = row.querySelector('input');
                    if (input) {
                        input.name = `newCustomer.contactPhones[${index}]`;
                    }
                    const removeButton = row.querySelector('.remove-object-phone');
                    if (removeButton) {
                        removeButton.style.display = index === 0 ? 'none' : '';
                    }
                });
            }

            toggle?.addEventListener('change', updateVisibility);
            updateVisibility();

            addPhoneButton?.addEventListener('click', () => {
                if (!(phoneTemplate instanceof HTMLTemplateElement) || !phoneContainer) {
                    return;
                }
                const fragment = phoneTemplate.content.firstElementChild?.cloneNode(true);
                if (!(fragment instanceof HTMLElement)) {
                    return;
                }
                phoneContainer.appendChild(fragment);
                reindexPhones();
            });

            phoneContainer?.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) {
                    return;
                }
                if (target.classList.contains('remove-object-phone')) {
                    const row = target.closest('.phone-row');
                    if (row && phoneContainer.children.length > 1) {
                        row.remove();
                        reindexPhones();
                    }
                }
            });

            reindexPhones();
        });
    </script>
</th:block>
</body>
</html>
