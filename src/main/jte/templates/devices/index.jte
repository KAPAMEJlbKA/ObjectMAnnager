@import com.kapamejlbka.objectmannage.domain.Device
@import com.kapamejlbka.objectmannage.domain.DeviceType
@import com.kapamejlbka.objectmannage.domain.Site
@import org.springframework.data.domain.Page
@import org.springframework.security.web.csrf.CsrfToken
@import java.time.ZoneId
@import java.time.format.DateTimeFormatter
@import java.util.LinkedHashMap
@import java.util.List
@import java.util.Map
@import java.util.UUID

@param Page<Device> devicesPage
@param List<Site> sites
@param DeviceType[] deviceTypes
@param UUID selectedSiteId = null
@param DeviceType selectedType = null
@param String q = null
@param CsrfToken _csrf
@param String flashSuccess = null
@param String flashError = null

<% DateTimeFormatter createdFormatter = DateTimeFormatter.ofPattern("dd.MM.yyyy HH:mm")
        .withZone(ZoneId.systemDefault());
   DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("dd.MM.yyyy");
   Map<String, String> paginationParams = new LinkedHashMap<>();
   if (selectedSiteId != null) {
       paginationParams.put("siteId", selectedSiteId.toString());
   }
   if (selectedType != null) {
       paginationParams.put("type", selectedType.name());
   }
   if (q != null && !q.isBlank()) {
       paginationParams.put("q", q);
   }
%>

@templates.layout(
        title = "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
        activePage = "devices",
        flashSuccess = flashSuccess,
        flashError = flashError
) {
    <section class="page-card">
        <div class="page-header">
            <div>
                <p class="eyebrow">–ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</p>
                <h1 class="page-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h1>
                <p class="page-subtitle">–§–∏–ª—å—Ç—Ä –ø–æ –ø–ª–æ—â–∞–¥–∫–µ, —Ç–∏–ø—É –∏ –ø–æ–∏—Å–∫—É –ø–æ –º–æ–¥–µ–ª–∏, —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∏–ª–∏ IP.</p>
            </div>
            <a class="button primary" href="/devices/new">–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</a>
        </div>

        <div class="filter-panel">
            <form method="get" action="/devices" class="filter-grid">
                <label class="filter-field">
                    <span>–ü–ª–æ—â–∞–¥–∫–∞</span>
                    <select name="siteId">
                        <option value="">–í—Å–µ –ø–ª–æ—â–∞–¥–∫–∏</option>
                        @for(Site site : sites) {
                            <option value="@site.getId()" @(selectedSiteId != null && selectedSiteId.equals(site.getId()) ? "selected" : "")>@site.getName()</option>
                        }
                    </select>
                </label>
                <label class="filter-field">
                    <span>–¢–∏–ø</span>
                    <select name="type">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        @for(DeviceType type : deviceTypes) {
                            <option value="@type.name()" @(selectedType == type ? "selected" : "")>@type.getDisplayName()</option>
                        }
                    </select>
                </label>
                <label class="filter-field">
                    <span>–ü–æ–∏—Å–∫</span>
                    <input type="text" name="q" value="@(q == null ? "" : q)" placeholder="–ú–æ–¥–µ–ª—å, —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ IP">
                </label>
                <div class="filter-actions">
                    <button type="submit" class="button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    @if((selectedSiteId != null) || (selectedType != null) || (q != null && !q.isBlank())) {
                        <a class="button ghost" href="/devices">–°–±—Ä–æ—Å–∏—Ç—å</a>
                    }
                </div>
            </form>
        </div>

        @if(devicesPage.isEmpty()) {
            <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <div>
                    <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p class="muted">–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.</p>
                </div>
            </div>
        } else {
            <div class="table-card">
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>–ü–ª–æ—â–∞–¥–∫–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                            <th>IP</th>
                            <th>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
                            <th>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</th>
                            <th>–°–æ–∑–¥–∞–Ω–æ</th>
                            <th class="actions-col"></th>
                        </tr>
                        </thead>
                        <tbody>
                        @for(Device device : devicesPage.getContent()) {
                            <tr>
                                <td>
                                    <div class="cell-main">@(device.getSite() != null ? device.getSite().getName() : "‚Äî")</div>
                                    <div class="cell-sub">@device.getId()</div>
                                </td>
                                <td><span class="pill">@device.getType().getDisplayName()</span></td>
                                <td>@(device.getModel() == null ? "‚Äî" : device.getModel())</td>
                                <td>@(device.getSerial() == null ? "‚Äî" : device.getSerial())</td>
                                <td>@(device.getIp() == null ? "‚Äî" : device.getIp())</td>
                                <td>@(device.getInstalledAt() == null ? "‚Äî" : dateFormatter.format(device.getInstalledAt()))</td>
                                <td>@(device.getLocationNote() == null ? "‚Äî" : device.getLocationNote())</td>
                                <td>@createdFormatter.format(device.getCreatedAt())</td>
                                <td class="row-actions">
                                    <a class="button ghost" href="/devices/@device.getId()/edit">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                                    <form method="post" action="/devices/@device.getId()/delete">
                                        <input type="hidden" name="@_csrf.getParameterName()" value="@_csrf.getToken()">
                                        <button type="submit" class="button danger">–£–¥–∞–ª–∏—Ç—å</button>
                                    </form>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                @templates.fragments.pagination(page = devicesPage, basePath = "/devices", params = paginationParams)
            </div>
        }
    </section>
}
